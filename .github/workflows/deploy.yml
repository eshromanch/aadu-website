name: Deploy Aadu Website

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: # Allow manual deployment

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linting
      run: npm run lint
      
    - name: Run type checking
      run: npx tsc --noEmit
      
    - name: Security audit
      run: npm audit --audit-level moderate
      
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.PORT }}
        envs: MONGODB_URI,JWT_SECRET
        script: |
          # Set error handling
          set -e
          
          PROJECT_DIR="/var/www/projects/aadu-website"
          
          echo "ðŸš€ Starting deployment..."
          
          # Check if project directory exists
          if [ ! -d "$PROJECT_DIR" ]; then
            echo "âŒ Project directory not found. Please run server-setup.sh first."
            exit 1
          fi
          
          cd $PROJECT_DIR
          
          # Stop the application
          echo "â¹ï¸  Stopping application..."
          pm2 stop aadu-website || true
          
          # Create backup
          echo "ðŸ’¾ Creating backup..."
          if [ -d "app" ]; then
            mkdir -p backups
            cp -r app backups/app-$(date +%Y%m%d_%H%M%S)
            # Keep only last 5 backups
            ls -t backups/ | tail -n +6 | xargs -I {} rm -rf backups/{}
          fi
          
          # Remove existing app directory for fresh clone
          echo "ðŸ—‘ï¸  Removing old code..."
          rm -rf app
          
          # Clone latest code
          echo "ðŸ“¥ Cloning latest code..."
          git clone https://github.com/eshromanch/aadu-website.git app
          
          cd app
          
          # Create .env.production file
          echo "âš™ï¸  Creating environment file..."
          cat > .env.production << ENV_EOF
          MONGODB_URI=$MONGODB_URI
          JWT_SECRET=$JWT_SECRET
          NODE_ENV=production
          PORT=3000
          ENV_EOF
          
          # Install dependencies and build
          echo "ðŸ“¦ Installing dependencies..."
          npm ci
          
          echo "ðŸ”¨ Building application..."
          # Ensure we're not building for static export
          export NEXT_EXPORT=false
          export BUILD_STANDALONE=false
          npm run build
          
          # Copy ecosystem config to app directory
          echo "ðŸ“‹ Copying PM2 configuration..."
          cp ../ecosystem.config.js .
          
          # Start/restart with PM2
          echo "ðŸš€ Starting application..."
          pm2 start ecosystem.config.js || pm2 restart aadu-website
          
          # Check PM2 status immediately
          echo "ðŸ“Š PM2 Status:"
          pm2 list
          
          # Check if process is actually running
          echo "ðŸ” Checking if process is listening on port 3000..."
          sleep 10
          if ss -tuln | grep :3000; then
            echo "âœ… Port 3000 is listening"
          else
            echo "âŒ Port 3000 is not listening"
            echo "ðŸ“‹ PM2 Status:"
            pm2 list
            echo "ðŸ” Process status:"
            ps aux | grep node | grep -v grep || echo "No Node.js processes found"
            echo "ðŸ“‹ Checking PM2 log files:"
            tail -n 10 /var/www/projects/aadu-website/app/logs/err.log 2>/dev/null || echo "No error logs found"
            tail -n 10 /var/www/projects/aadu-website/app/logs/out.log 2>/dev/null || echo "No output logs found"
            
            # Give PM2 more time to start the application
            echo "â³ Giving PM2 more time to start the application..."
            sleep 20
          fi
          
          # Test and reload Nginx
          echo "ðŸŒ Reloading Nginx..."
          sudo nginx -t && sudo systemctl reload nginx
          
          # Wait for application to start
          echo "â³ Waiting for application to start..."
          sleep 30
          
          # Health check
          echo "ðŸ¥ Running health check..."
          echo "Testing health endpoint..."
          if timeout 10s curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
            echo "âœ… Health endpoint is working on port 3000"
          elif timeout 10s curl -f http://localhost:3000 > /dev/null 2>&1; then
            echo "âœ… Root endpoint is working on port 3000"
          elif timeout 10s curl -f http://localhost:3001/api/health > /dev/null 2>&1; then
            echo "âœ… Health endpoint is working on port 3001"
          elif timeout 10s curl -f http://localhost:3001 > /dev/null 2>&1; then
            echo "âœ… Root endpoint is working on port 3001"
          else
            echo "âŒ No endpoints are responding"
            echo "Testing with verbose output:"
            timeout 10s curl -v http://localhost:3000/api/health || echo "Port 3000 health endpoint timeout"
            timeout 10s curl -v http://localhost:3000/ || echo "Port 3000 root endpoint timeout"
            timeout 10s curl -v http://localhost:3001/api/health || echo "Port 3001 health endpoint timeout"
            timeout 10s curl -v http://localhost:3001/ || echo "Port 3001 root endpoint timeout"
            exit 1
          fi
            echo "âœ… Application is running successfully"
            
            # Run monitoring health check
            if [ -f "/var/monitoring/aadu-website/health-check.sh" ]; then
              /var/monitoring/aadu-website/health-check.sh
            fi
            
          else
            echo "âŒ Application failed to start"
            echo "ðŸ“‹ Application logs:"
            pm2 logs aadu-website --lines 20
            exit 1
          fi
          
          # Create deployment log
          echo "ðŸ“ Logging deployment..."
          echo "$(date): Deployment completed successfully" >> $PROJECT_DIR/logs/deployment.log
          
          echo "ðŸŽ‰ Deployment completed successfully!"
          
          # Show application status
          echo "ðŸ“Š Application status:"
          pm2 list
          
      env:
        MONGODB_URI: ${{ secrets.MONGODB_URI }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        NODE_ENV: production
        PORT: 3001