name: Deploy Website to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests
      run: npm test
      
    - name: Build application
      run: npm run build
      env:
        NODE_ENV: production
        
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          # Set error handling
          set -e
          
          # Configuration
          PROJECT_NAME="aadu-website"
          PROJECT_DIR="/var/www/projects/$PROJECT_NAME"
          BACKUP_DIR="$PROJECT_DIR/backups"
          
          echo "ðŸš€ Starting deployment for $PROJECT_NAME..."
          
          # Check if project directory exists
          if [ ! -d "$PROJECT_DIR" ]; then
            echo "âŒ Project directory not found. Creating..."
            mkdir -p $PROJECT_DIR/{app,logs,backups,ssl,config}
          fi
          
          cd $PROJECT_DIR
          
          # Stop the application
          echo "â¹ï¸ Stopping application..."
          pm2 stop $PROJECT_NAME || true
          
          # Create backup
          echo "ðŸ’¾ Creating backup..."
          if [ -d "app" ]; then
            mkdir -p $BACKUP_DIR
            cp -r app $BACKUP_DIR/app-$(date +%Y%m%d_%H%M%S)
            # Keep only last 5 backups
            ls -t $BACKUP_DIR/ | tail -n +6 | xargs -I {} rm -rf $BACKUP_DIR/{}
          fi
          
          # Remove existing app directory for fresh clone
          echo "ðŸ—‘ï¸ Removing old code..."
          rm -rf app
          
          # Clone latest code
          echo "ðŸ“¥ Cloning latest code..."
          git clone https://github.com/${{ github.repository }}.git app
          cd app
          
          # Install dependencies
          echo "ðŸ“¦ Installing dependencies..."
          npm ci --production
          
          # Create environment file
          echo "âš™ï¸ Creating environment file..."
          cat > .env.production << 'ENV_EOF'
          MONGODB_URI=${{ secrets.MONGODB_URI }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          NODE_ENV=production
          PORT=3001
          ENV_EOF
          
          # Build application
          echo "ðŸ”¨ Building application..."
          rm -rf .next
          npm run build
          
          # Copy PM2 configuration
          echo "ðŸ“‹ Copying PM2 configuration..."
          cp ../ecosystem.config.js .
          
          # Start application
          echo "ðŸš€ Starting application..."
          pm2 delete $PROJECT_NAME || true
          pm2 start ecosystem.config.js
          
          # Reload Nginx
          echo "ðŸŒ Reloading Nginx..."
          nginx -t && systemctl reload nginx
          
          # Wait for application to start
          echo "â³ Waiting for application to start..."
          sleep 15
          
          # Health check
          echo "ðŸ¥ Running health check..."
          if curl -f http://localhost:3001/api/health || curl -f http://localhost:3001; then
            echo "âœ… Application is running successfully"
          else
            echo "âŒ Application failed to start"
            echo "ðŸ“‹ Application logs:"
            pm2 logs $PROJECT_NAME --lines 20
            exit 1
          fi
          
          echo "ðŸŽ‰ Deployment completed successfully!"
          
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Deployment successful!"
        else
          echo "âŒ Deployment failed!"
        fi
